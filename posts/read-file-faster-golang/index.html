<!doctype html><html lang=ja-jp><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=generator content="Hugo 0.85.0"><title>なぜioutil.ReadFileはioutil.ReadAllより速いか</title><link rel=canonical href=https://raahii.me/posts/read-file-faster-golang/><meta http-equiv=refresh content="0; url=https://raahii.me/posts/read-file-faster-golang/"><link href=https://raahii.github.io/favicon.ico rel=icon type=image/x-icon><meta property="description" content="なぜioutil.ReadFileはioutil.ReadAllより速いか"><meta property="og:title" content="なぜioutil.ReadFileはioutil.ReadAllより速いか"><meta property="og:description" content="なぜioutil.ReadFileはioutil.ReadAllより速いか"><meta property="og:type" content="article"><meta property="og:url" content="https://raahii.github.io/posts/read-file-faster-golang/"><meta property="article:section" content="post"><meta property="article:published_time" content="2019-10-13T00:36:12+09:00"><meta property="article:modified_time" content="2019-10-13T00:36:12+09:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="なぜioutil.ReadFileはioutil.ReadAllより速いか"><meta name=twitter:description content="なぜioutil.ReadFileはioutil.ReadAllより速いか"><link rel=icon href=https://raahii.github.io/images/favicon.ico type=image/x-icon><link rel=stylesheet href=https://raahii.github.io/css/main.css media=all><link rel=stylesheet href="//fonts.googleapis.com/css?family=Merriweather:400|Lato:400,400italic,700"></head><body><div class=wrapper><header class=header><nav class=nav><a href=https://raahii.github.io/ class=nav-logo><img src=https://raahii.github.io/images/bird.svg width=45 height=45 alt=Logo><p class=nav-title>1ミリもわからん</p></a><ul class=nav-links><li><a href=/tags/>Tags</a></li><li><a href=/about/>About</a></li><li><a href=https://github.com/raahii target=_blank>GitHub</a></li><li><a href=https://twitter.com/raahiiy target=_blank>Twitter</a></li></ul></nav></header><main class=content role=main><article class=article><h1 class=article-title>なぜioutil.ReadFileはioutil.ReadAllより速いか</h1><span class=article-date>October 13, 2019</span>
<span class=article-duration>2 min read</span><ul class="cp_tag01 article-categories">Categories:<li><a href=/categories/%E6%8A%80%E8%A1%93/>技術</a></li></ul><ul class="cp_tag01 article-tags">Tags:<li><a href=/tags/golang/>golang</a></li><li><a href=/tags/io/>io</a></li><li><a href=/tags/benchmark/>benchmark</a></li><li><a href=/tags/%E9%AB%98%E9%80%9F%E5%8C%96/>高速化</a></li><li><a href=/tags/%E3%82%B3%E3%83%BC%E3%83%89%E3%83%AA%E3%83%BC%E3%83%87%E3%82%A3%E3%83%B3%E3%82%B0/>コードリーディング</a></li></ul><div class=article-content><h1 id=tldr>TL;DR</h1><p>Goで<strong>ファイル内容を読む場合</strong> には，<code>ioutil.ReadFile</code> の方が <code>ioutil.ReadAll</code> よりも高速．なぜなら，読み込むデータの大きさがあらかじめわかっている場合は，内部のバッファサイズを決定でき，無駄なメモリ確保を無くせるから．</p><p>（いやなんで<code>ReadAll</code>を使うんだよ，というのはさておき．）</p><h1 id=ioutilパッケージの関数たち>ioutilパッケージの関数たち</h1><p>Go言語には入力や出力を抽象化したインターフェース（<code>io.Reader</code> や<code>io.Writer</code> など）がある．このインターフェースはいわゆるファイル的な振る舞いをするものをまるっと同じように扱うためにとても便利なもの．<code>ioutil</code> パッケージも当然，それらをベースとしてさまざまな関数を実装している．</p><ul><li><a href=https://golang.org/pkg/io/#Reader>io.Reader</a> / <a href=https://golang.org/pkg/io/#Writer>io.Writer</a></li></ul><p>ただし，抽象化するということは，それぞれに特化できないということでもある．実際に <code>ioutil.ReadAll</code> のコードを読むと，最初に512 バイトのバッファを用意し，ファイルのEOFを検知するまで2倍，4倍，8倍…とそのサイズを大きくしながら読み込みを行っている．これは，<code>io.Reader</code> から一体どのくらいのデータを読み込むかわからないために行うバッファリングの処理である．</p><ul><li><a href="https://golang.org/src/io/ioutil/ioutil.go?s=1186:1227#L34">func ReadAll - ioutil</a></li></ul><p>そこで，<code>ioutil.ReadFile</code>関数では，事前に<code>os</code>パッケージを使ってファイルの大きさを取得し，バッファサイズをそのとおりに確保することで一度にすべての内容を読み込んでいる．<code>ioutil.ReadAll</code> と同じAPIを使いたい場合には，ファイルオープンしてサイズを取得したあとに，<code>io.ReadFull</code> や<code>io.ReadAtLeast</code>を使うと良いと思う．</p><h2 id=ベンチマーク>ベンチマーク</h2><ul><li><p>ソースコード</p><p>最初の関数は固定長のバッファで読み込んだ場合．次は <code>ioutil.ReadAll</code> を使う場合．これは指数的にバッファサイズを大きくしていくので可変長のバッファで読み込むということ．次に <code>iotuil.ReadFile</code>．最後が<code>ioutil.ReadFile</code>と同等の処理をファイルサイズ取得+<code>io.ReadAll</code>で実装したもの．</p></li></ul><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#000;font-weight:700>package</span> main

<span style=color:#000;font-weight:700>import</span> (
	<span style=color:#d14>&#34;io&#34;</span>
	<span style=color:#d14>&#34;io/ioutil&#34;</span>
	<span style=color:#d14>&#34;os&#34;</span>
	<span style=color:#d14>&#34;testing&#34;</span>
)

<span style=color:#000;font-weight:700>var</span> filename = <span style=color:#d14>&#34;bigfile&#34;</span> <span style=color:#998;font-style:italic>// 804,335,663 bytes
</span><span style=color:#998;font-style:italic></span>
<span style=color:#000;font-weight:700>func</span> <span style=color:#900;font-weight:700>BenchmarkFixedSizeBuffer</span>(b <span style=color:#000;font-weight:700>*</span>testing.B) {
	BUFSIZE <span style=color:#000;font-weight:700>:=</span> <span style=color:#099>4</span> <span style=color:#000;font-weight:700>*</span> <span style=color:#099>1024</span>

	<span style=color:#000;font-weight:700>for</span> i <span style=color:#000;font-weight:700>:=</span> <span style=color:#099>0</span>; i &lt; b.N; i<span style=color:#000;font-weight:700>++</span> {
		file, err <span style=color:#000;font-weight:700>:=</span> os.<span style=color:#900;font-weight:700>Open</span>(filename)
		<span style=color:#000;font-weight:700>if</span> err <span style=color:#000;font-weight:700>!=</span> <span style=color:#000;font-weight:700>nil</span> {
			<span style=color:#0086b3>panic</span>(err)
		}
		<span style=color:#000;font-weight:700>defer</span> file.<span style=color:#900;font-weight:700>Close</span>()

		data <span style=color:#000;font-weight:700>:=</span> <span style=color:#0086b3>make</span>([]<span style=color:#458;font-weight:700>byte</span>, <span style=color:#099>0</span>, BUFSIZE)

		buf <span style=color:#000;font-weight:700>:=</span> <span style=color:#0086b3>make</span>([]<span style=color:#458;font-weight:700>byte</span>, BUFSIZE)
		<span style=color:#000;font-weight:700>for</span> {
			n, err <span style=color:#000;font-weight:700>:=</span> file.<span style=color:#900;font-weight:700>Read</span>(buf)
			<span style=color:#000;font-weight:700>if</span> n <span style=color:#000;font-weight:700>==</span> <span style=color:#099>0</span> {
				<span style=color:#000;font-weight:700>break</span>
			}
			<span style=color:#000;font-weight:700>if</span> err <span style=color:#000;font-weight:700>!=</span> <span style=color:#000;font-weight:700>nil</span> {
				<span style=color:#0086b3>panic</span>(err)
			}
			data = <span style=color:#0086b3>append</span>(data, buf<span style=color:#000;font-weight:700>...</span>)
		}
	}
}

<span style=color:#000;font-weight:700>func</span> <span style=color:#900;font-weight:700>BenchmarkReadAll</span>(b <span style=color:#000;font-weight:700>*</span>testing.B) {
	<span style=color:#000;font-weight:700>for</span> i <span style=color:#000;font-weight:700>:=</span> <span style=color:#099>0</span>; i &lt; b.N; i<span style=color:#000;font-weight:700>++</span> {
		file, err <span style=color:#000;font-weight:700>:=</span> os.<span style=color:#900;font-weight:700>Open</span>(filename)
		<span style=color:#000;font-weight:700>if</span> err <span style=color:#000;font-weight:700>!=</span> <span style=color:#000;font-weight:700>nil</span> {
			<span style=color:#0086b3>panic</span>(err)
		}
		<span style=color:#000;font-weight:700>defer</span> file.<span style=color:#900;font-weight:700>Close</span>()

		_, err = ioutil.<span style=color:#900;font-weight:700>ReadAll</span>(file)
		<span style=color:#000;font-weight:700>if</span> err <span style=color:#000;font-weight:700>!=</span> <span style=color:#000;font-weight:700>nil</span> {
			<span style=color:#0086b3>panic</span>(err)
		}
	}
}

<span style=color:#000;font-weight:700>func</span> <span style=color:#900;font-weight:700>BenchmarkReadFile</span>(b <span style=color:#000;font-weight:700>*</span>testing.B) {
	<span style=color:#000;font-weight:700>for</span> i <span style=color:#000;font-weight:700>:=</span> <span style=color:#099>0</span>; i &lt; b.N; i<span style=color:#000;font-weight:700>++</span> {
		_, err <span style=color:#000;font-weight:700>:=</span> ioutil.<span style=color:#900;font-weight:700>ReadFile</span>(filename)
		<span style=color:#000;font-weight:700>if</span> err <span style=color:#000;font-weight:700>!=</span> <span style=color:#000;font-weight:700>nil</span> {
			<span style=color:#0086b3>panic</span>(err)
		}
	}
}

<span style=color:#000;font-weight:700>func</span> <span style=color:#900;font-weight:700>BenchmarkReadFull</span>(b <span style=color:#000;font-weight:700>*</span>testing.B) {
	<span style=color:#000;font-weight:700>for</span> i <span style=color:#000;font-weight:700>:=</span> <span style=color:#099>0</span>; i &lt; b.N; i<span style=color:#000;font-weight:700>++</span> {
		file, err <span style=color:#000;font-weight:700>:=</span> os.<span style=color:#900;font-weight:700>Open</span>(filename)
		<span style=color:#000;font-weight:700>if</span> err <span style=color:#000;font-weight:700>!=</span> <span style=color:#000;font-weight:700>nil</span> {
			<span style=color:#0086b3>panic</span>(err)
		}
		<span style=color:#000;font-weight:700>defer</span> file.<span style=color:#900;font-weight:700>Close</span>()

		fi, err <span style=color:#000;font-weight:700>:=</span> file.<span style=color:#900;font-weight:700>Stat</span>()
		<span style=color:#000;font-weight:700>if</span> err <span style=color:#000;font-weight:700>!=</span> <span style=color:#000;font-weight:700>nil</span> {
			<span style=color:#0086b3>panic</span>(err)
		}

		data <span style=color:#000;font-weight:700>:=</span> <span style=color:#0086b3>make</span>([]<span style=color:#458;font-weight:700>byte</span>, fi.<span style=color:#900;font-weight:700>Size</span>())
		_, err = io.<span style=color:#900;font-weight:700>ReadFull</span>(file, data)
		<span style=color:#000;font-weight:700>if</span> err <span style=color:#000;font-weight:700>!=</span> <span style=color:#000;font-weight:700>nil</span> {
			<span style=color:#0086b3>panic</span>(err)
		}
	}
}
</code></pre></div><ul><li>結果</li></ul><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>❯ go <span style=color:#0086b3>test</span> -bench . -benchmem -o pprof/test.bin  -cpuprofile pprof/cpu.out
goos: darwin
goarch: amd64
pkg: github.com/raahii/go-sandbox/read-bigfile
BenchmarkFixedSizeBuffer-4             <span style=color:#099>3</span>         <span style=color:#099>363437901</span> ns/op        <span style=color:#099>1293321805</span> B/op       <span style=color:#099>51</span> allocs/op
BenchmarkReadAll-4                     <span style=color:#099>7</span>         <span style=color:#099>171374293</span> ns/op        <span style=color:#099>536869438</span> B/op        <span style=color:#099>23</span> allocs/op
BenchmarkReadFile-4                   <span style=color:#099>21</span>          <span style=color:#099>47905628</span> ns/op        <span style=color:#099>209305932</span> B/op         <span style=color:#099>5</span> allocs/op
BenchmarkReadFull-4                   <span style=color:#099>25</span>          <span style=color:#099>44724078</span> ns/op        <span style=color:#099>209305966</span> B/op         <span style=color:#099>5</span> allocs/op
PASS
ok      github.com/raahii/go-sandbox/read-bigfile       7.531s
</code></pre></div><h2 id=->💁‍♀️ 💬</h2><p>ただ，あくまでI/Oが高速であるという前提があるから成り立つ話であり，ネットワーク越しのデータアクセスのようにI/Oが遅い場合には．うまく並行処理を使ってバッファリングすると高速になるケースがあると思う．特に，最近インターンでAWS S3の大きめのファイルにアクセスする時にパフォーマンスが落ちる問題があったので<code>bufio</code>まわりのパッケージを読んでみようと思う．</p></div></article><div id=disqus_thread></div><script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return}var b=document,a=b.createElement('script');a.async=!0,a.src='//raahii.disqus.com/embed.js',a.setAttribute('data-timestamp',+new Date),(b.head||b.body).appendChild(a)})()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a><h3>こちらの記事もどうぞ</h3><ul class="related-content article-content"><li><a href=/posts/divisor-enumeration/>約数の全列挙の高速化</a></li><li><a href=/posts/optional-parameters-in-go/>Goでオプショナルパラメータをどう扱うか</a></li><li><a href=/posts/aircon-timer-with-google-home-and-nature-remo/>Google HomeとNature Remoでエアコンのタイマーを快適にセットする</a></li><li><a href=/posts/automating-hugo-builds-with-github-actions/>HugoのビルドをGithub Actionで自動化する</a></li><li><a href=/posts/permutations-in-go/>Goで順列（permutation）を実装する</a></li></ul></main><footer class=footer><ul class=footer-links><li><a href=https://gohugo.io/ class=footer-links-kudos>Made with <img src=https://raahii.github.io/images/hugo-logo.png width=22 height=22 alt="hugo log"></a></li></ul></footer></div><script async src="https://www.googletagmanager.com/gtag/js?id=G-D4N0KPT2K2"></script><script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-D4N0KPT2K2',{anonymize_ip:!1})}</script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.10.1/dist/katex.min.css integrity=sha384-dbVIfZGuN1Yq7/1Ocstc1lUEm+AT+/rCkibIcC/OmWo5f0EA48Vf8CytHzGrSwbQ crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.10.1/dist/katex.min.js integrity=sha384-2BKqo+exmr9su6dir+qCw08N2ZKRucY4PrGQPPWU1A7FtlCGjmEGFqXCv5nyM5Ij crossorigin=anonymous></script><script defer src=https://cdn.jsdelivr.net/npm/katex@0.10.1/dist/contrib/auto-render.min.js integrity=sha384-kWPLUVMOks5AQFrykwIup5lo0m3iMkkHrD0uJ4H5cjeGihAutqP0yW0J6dpFiVkI crossorigin=anonymous onload=renderMathInElement(document.body)></script><script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}]})})</script></body></html>