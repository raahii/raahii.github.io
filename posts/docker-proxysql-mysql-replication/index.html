<!doctype html><html lang=ja-jp><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=generator content="Hugo 0.85.0"><title>ProxySQLã§MySQLã®è² è·åˆ†æ•£ã‚’ã™ã‚‹</title><link rel=canonical href=https://raahii.me/posts/docker-proxysql-mysql-replication/><meta name=robots content="noindex"><meta http-equiv=refresh content="0; url=https://raahii.me/posts/docker-proxysql-mysql-replication/"><link href=https://raahii.github.io/favicon.ico rel=icon type=image/x-icon><meta property="description" content="ProxySQLã§MySQLã‚’è² è·åˆ†æ•£ã™ã‚‹â€¨"><meta property="keywords" content="proxysql, mysql, replication, grafana, prometheus, load balancing"><meta property="og:title" content="ProxySQLã§MySQLã®è² è·åˆ†æ•£ã‚’ã™ã‚‹"><meta property="og:description" content="ProxySQLã§MySQLã‚’è² è·åˆ†æ•£ã™ã‚‹â€¨"><meta property="og:type" content="article"><meta property="og:url" content="https://raahii.github.io/posts/docker-proxysql-mysql-replication/"><meta property="og:image" content="https://user-images.githubusercontent.com/13511520/83347412-e2c4f280-a35f-11ea-8048-2b0645e99245.png"><meta property="article:section" content="post"><meta property="article:published_time" content="2020-05-31T17:20:27+09:00"><meta property="article:modified_time" content="2020-05-31T17:20:27+09:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://user-images.githubusercontent.com/13511520/83347412-e2c4f280-a35f-11ea-8048-2b0645e99245.png"><meta name=twitter:title content="ProxySQLã§MySQLã®è² è·åˆ†æ•£ã‚’ã™ã‚‹"><meta name=twitter:description content="ProxySQLã§MySQLã‚’è² è·åˆ†æ•£ã™ã‚‹â€¨"><link rel=icon href=https://raahii.github.io/images/favicon.ico type=image/x-icon><link rel=stylesheet href=https://raahii.github.io/css/main.css media=all><link rel=stylesheet href="//fonts.googleapis.com/css?family=Merriweather:400|Lato:400,400italic,700"></head><body><div class=wrapper><header class=header><nav class=nav><a href=https://raahii.github.io/ class=nav-logo><img src=https://raahii.github.io/images/bird.svg width=45 height=45 alt=Logo><p class=nav-title>1ãƒŸãƒªã‚‚ã‚ã‹ã‚‰ã‚“</p></a><ul class=nav-links><li><a href=/tags/>Tags</a></li><li><a href=/about/>About</a></li><li><a href=https://github.com/raahii target=_blank>GitHub</a></li><li><a href=https://twitter.com/raahiiy target=_blank>Twitter</a></li></ul></nav></header><main class=content role=main><article class=article><h1 class=article-title>ProxySQLã§MySQLã®è² è·åˆ†æ•£ã‚’ã™ã‚‹</h1><span class=article-date>May 31, 2020</span>
<span class=article-duration>5 min read</span><ul class="cp_tag01 article-categories">Categories:<li><a href=/categories/%E9%96%8B%E7%99%BA/>é–‹ç™º</a></li></ul><ul class="cp_tag01 article-tags">Tags:<li><a href=/tags/proxysql/>proxysql</a></li><li><a href=/tags/mysql/>mysql</a></li><li><a href=/tags/replication/>replication</a></li><li><a href=/tags/grafana/>grafana</a></li><li><a href=/tags/prometheus/>prometheus</a></li></ul><div class=article-content><div class=thumnail><a href=https://user-images.githubusercontent.com/13511520/83347412-e2c4f280-a35f-11ea-8048-2b0645e99245.png class=dont-hightlight><img src=https://user-images.githubusercontent.com/13511520/83347412-e2c4f280-a35f-11ea-8048-2b0645e99245.png width=90% alt=overview></a></div><aside class=x-toc><div class=x-toc-title>ç›®æ¬¡</div><nav id=TableOfContents><ul><li><a href=#ã¯ã˜ã‚ã«>ã¯ã˜ã‚ã«</a></li><li><a href=#mysqlã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—>MySQLã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—</a></li><li><a href=#proxysqlã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—>ProxySQLã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—</a></li><li><a href=#sysbenchã§è² è·ã‚’ã‹ã‘ã¦ã¿ã‚‹>sysbenchã§è² è·ã‚’ã‹ã‘ã¦ã¿ã‚‹</a></li><li><a href=#ãŠã‚ã‚Šã«>ãŠã‚ã‚Šã«</a></li><li><a href=#appendix>Appendix</a></li></ul></nav></aside><h2 id=ã¯ã˜ã‚ã«>ã¯ã˜ã‚ã«</h2><p>å‰å›ã€<a href=https://raahii.github.io/posts/docker-mysql-master-slave-replication/>MySQLã®master slaveæ§‹æˆã‚’Dockerã§ä½œã£ã¦ã¿ãŸ</a> ãŒã€å®Ÿéš›ã®é–‹ç™ºã§ã¯è¤‡æ•°DBã‚’ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‹ã‚‰ä½¿ã†ã«ã¯ä¸€å·¥å¤«å¿…è¦ã§ã‚ã‚‹ã€‚ã‚‚ã£ã¨ã‚‚ç´ æœ´ãªæ–¹æ³•ã¯ä½¿ç”¨ã™ã‚‹DBã®æ¥ç¶šæƒ…å ±ã‚’ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ã™ã¹ã¦ä¿æŒã—ã¦ãŠãã€readç³»/writeç³»ã§ä½¿ã„åˆ†ã‘ã‚‹ã“ã¨ã ã¨æ€ã†ã€‚ã—ã‹ã—ã€ã“ã‚Œã¯æ¬¡ã®ã‚ˆã†ãªå•é¡ŒãŒã‚ã‚‹ã€‚</p><ul><li>DBã®æ¥ç¶šæƒ…å ±ã¯é€”ä¸­ã§å¤‰ã‚ã‚Šã†ã‚‹</li><li>ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ­ã‚¸ãƒƒã‚¯ã«DBã®ä½¿ã„åˆ†ã‘ãŒå…¥ã‚‹ã®ã¯é¢å€’ï¼ˆã ã—è¤‡é›‘ï¼‰</li></ul><p>ãã“ã§ã€ä»Šå›ã¯ <a href=https://proxysql.com/>ProxySQL</a> ã‚’è©¦ã—ã¦ã¿ã‚‹ã€‚ProxySQLã¯ ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¨DBã®é–“ã«å…¥ã£ã¦ã€æ¬¡ã®ã‚ˆã†ãªã“ã¨ã‚’ã—ã¦ãã‚Œã‚‹ã€‚</p><ul><li>ã‚¯ã‚¨ãƒªã«å¿œã˜ãŸmaster / slave ã¸ã®è‡ªå‹•ãƒ—ãƒ­ã‚­ã‚·</li><li>è² è·åˆ†æ•£</li><li>ã‚·ãƒ¼ãƒ ãƒ¬ã‚¹ãªæ¥ç¶šè¨­å®šã®å¤‰æ›´</li></ul><p>ã©ã®ç¨‹åº¦ãƒ¡ã‚¸ãƒ£ãƒ¼ãªã®ã‹ã¯ã„ã¾ã„ã¡ã‚ã‹ã£ã¦ã„ãªã„ãŒã€å…¬å¼ã® <a href=https://github.com/mysql/mysql-proxy>mysql-proxy</a>ã‚ˆã‚Šã¯ä½¿ã‚ã‚Œã¦ã„ã‚‹ã‚ˆã†ã ã£ãŸã®ã§é¸ã‚“ã ã€‚ã¡ãªã¿ã«ProxySQLã¯MysQLä»¥å¤–ã®DBã§ã‚‚ä½¿ãˆã‚‹ã€‚</p><h2 id=mysqlã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—>MySQLã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—</h2><p>å‰å›ã«ç¶šã„ã¦MySQL8.0ã‚’ä½¿ã„ã€masterã‚’1ã¤ã€slaveã‚’2ã¤ç”¨æ„ã—ã¦ãƒ¬ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³è¨­å®šã‚’çµ„ã‚“ã§ãŠã„ãŸã€‚</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-docker data-lang=docker>version: <span style=color:#d14>&#34;3&#34;</span><span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2></span>services:<span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2></span>  mysql-master:<span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2></span>    image: mysql:8.0<span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2></span>    container_name: proxysql-mysql-replication-master<span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2></span>    environment:<span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2></span>      MYSQL_ROOT_PASSWORD: password<span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2></span>      MYSQL_DATABASE: sbtest<span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2></span>    volumes:<span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2></span>      - ./master/my.cnf:/etc/mysql/my.cnf<span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2></span>      - ./master/data:/var/lib/mysql<span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2></span>      - ./master/init.sql:/docker-entrypoint-initdb.d/init.sql<span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2></span>    ports:<span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2></span>      - 3306:3306<span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2></span>  mysql-slave1:<span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2></span>    image: mysql:8.0<span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2></span>    container_name: proxysql-mysql-replication-slave1<span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2></span>    environment:<span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2></span>      MYSQL_ROOT_PASSWORD: password<span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2></span>      MYSQL_DATABASE: sbtest<span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2></span>    volumes:<span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2></span>      - ./slave/my-slave1.cnf:/etc/mysql/my.cnf<span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2></span>      - ./slave/data/slave1:/var/lib/mysql<span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2></span>      - ./slave/init.sql:/docker-entrypoint-initdb.d/init.sql<span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2></span>    ports:<span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2></span>      - 3307:3306<span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2></span>    depends_on:<span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2></span>      - mysql-master<span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2></span>  mysql-slave2:<span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2></span>    image: mysql:8.0<span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2></span>    container_name: proxysql-mysql-replication-slave2<span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2></span>    environment:<span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2></span>      MYSQL_ROOT_PASSWORD: password<span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2></span>      MYSQL_DATABASE: sbtest<span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2></span>    volumes:<span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2></span>      - ./slave/my-slave2.cnf:/etc/mysql/my.cnf<span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2></span>      - ./slave/data/slave2:/var/lib/mysql<span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2></span>      - ./slave/init.sql:/docker-entrypoint-initdb.d/init.sql<span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2></span>    ports:<span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2></span>      - 3308:3306<span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2></span>    depends_on:<span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2></span>      - mysql-master<span style=color:#a61717;background-color:#e3d2d2>
</span></code></pre></div><p>ç«‹ã¡ä¸Šã’ã¦ã€masterã¨slaveã®çŠ¶æ…‹ã‚’ç¢ºèªã€‚ã¾ãšmasterã€‚</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>â¯ docker-compose <span style=color:#0086b3>exec</span> mysql-master sh -c <span style=color:#d14>&#34;export MYSQL_PWD=password; mysql -u root sbtest -e &#39;show master status\G&#39;&#34;</span>
*************************** 1. row ***************************
             File: mysql-bin.000001
         Position: <span style=color:#099>156</span>
     Binlog_Do_DB: sbtest
 Binlog_Ignore_DB:
Executed_Gtid_Set: 0efd14cd-a27a-11ea-9d90-0242ac1a0002:1-67
</code></pre></div><p>slave1ã€‚ã‚‚ã†ä¸€ã¤ã‚‚åŒæ§˜ã€‚</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>â¯ docker-compose <span style=color:#0086b3>exec</span> mysql-slave1 sh -c <span style=color:#d14>&#34;export MYSQL_PWD=password; mysql -u root sbtest -e &#39;show slave status\G&#39;&#34;</span>
*************************** 1. row ***************************
               Slave_IO_State: Waiting <span style=color:#000;font-weight:700>for</span> master to send event
                  Master_Host: mysql-master
                  Master_User: slave_user
                  Master_Port: <span style=color:#099>3306</span>
                Connect_Retry: <span style=color:#099>60</span>
              Master_Log_File: mysql-bin.000003
          Read_Master_Log_Pos: <span style=color:#099>196</span>
               Relay_Log_File: mysql-relay-bin.000007
                Relay_Log_Pos: <span style=color:#099>411</span>
        Relay_Master_Log_File: mysql-bin.000003
             Slave_IO_Running: Yes
            Slave_SQL_Running: Yes
...
</code></pre></div><p>è‰¯ã•ãã†ã€‚</p><h2 id=proxysqlã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—>ProxySQLã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—</h2><p>æ¬¡ã«ProxySQLã€‚è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã¯æ¬¡ã®ã‚ˆã†ã«ã—ãŸã€‚</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-docker data-lang=docker><span style=color:#998;font-style:italic># proxysql.cnf</span><span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2></span><span style=color:teal>datadir</span><span style=color:#000;font-weight:700>=</span><span style=color:#d14>&#34;/var/lib/proxysql&#34;</span><span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2></span><span style=color:teal>admin_variables</span><span style=color:#000;font-weight:700>=</span><span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2></span><span style=color:#000;font-weight:700>{</span><span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2></span>    <span style=color:teal>admin_credentials</span><span style=color:#000;font-weight:700>=</span><span style=color:#d14>&#34;admin:admin;admin2:pass2&#34;</span><span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2></span>    <span style=color:teal>mysql_ifaces</span><span style=color:#000;font-weight:700>=</span><span style=color:#d14>&#34;0.0.0.0:6032&#34;</span><span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2></span>    <span style=color:teal>refresh_interval</span><span style=color:#000;font-weight:700>=</span><span style=color:#099>2000</span><span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2></span>    <span style=color:teal>stats_credentials</span><span style=color:#000;font-weight:700>=</span><span style=color:#d14>&#34;stats:admin&#34;</span><span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2></span><span style=color:#000;font-weight:700>}</span><span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2></span><span style=color:teal>mysql_variables</span><span style=color:#000;font-weight:700>=</span><span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2></span><span style=color:#000;font-weight:700>{</span><span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2></span>    <span style=color:teal>threads</span><span style=color:#000;font-weight:700>=</span><span style=color:#099>4</span><span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2></span>    <span style=color:teal>max_connections</span><span style=color:#000;font-weight:700>=</span><span style=color:#099>2048</span><span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2></span>    <span style=color:teal>default_query_delay</span><span style=color:#000;font-weight:700>=</span><span style=color:#099>0</span><span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2></span>    <span style=color:teal>default_query_timeout</span><span style=color:#000;font-weight:700>=</span><span style=color:#099>36000000</span><span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2></span>    <span style=color:teal>have_compress</span><span style=color:#000;font-weight:700>=</span>true<span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2></span>    <span style=color:teal>poll_timeout</span><span style=color:#000;font-weight:700>=</span><span style=color:#099>2000</span><span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2></span>    <span style=color:teal>interfaces</span><span style=color:#000;font-weight:700>=</span><span style=color:#d14>&#34;0.0.0.0:6033;/tmp/proxysql.sock&#34;</span><span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2></span>    <span style=color:teal>default_schema</span><span style=color:#000;font-weight:700>=</span><span style=color:#d14>&#34;information_schema&#34;</span><span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2></span>    <span style=color:teal>stacksize</span><span style=color:#000;font-weight:700>=</span><span style=color:#099>1048576</span><span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2></span>    <span style=color:teal>server_version</span><span style=color:#000;font-weight:700>=</span><span style=color:#d14>&#34;8.0&#34;</span><span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2></span>    <span style=color:teal>connect_timeout_server</span><span style=color:#000;font-weight:700>=</span><span style=color:#099>10000</span><span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2></span>    <span style=color:teal>monitor_history</span><span style=color:#000;font-weight:700>=</span><span style=color:#099>60000</span><span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2></span>    <span style=color:teal>monitor_connect_interval</span><span style=color:#000;font-weight:700>=</span><span style=color:#099>200000</span><span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2></span>    <span style=color:teal>monitor_ping_interval</span><span style=color:#000;font-weight:700>=</span><span style=color:#099>200000</span><span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2></span>    <span style=color:teal>ping_interval_server_msec</span><span style=color:#000;font-weight:700>=</span><span style=color:#099>10000</span><span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2></span>    <span style=color:teal>ping_timeout_server</span><span style=color:#000;font-weight:700>=</span><span style=color:#099>200</span><span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2></span>    <span style=color:teal>commands_stats</span><span style=color:#000;font-weight:700>=</span>true<span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2></span>    <span style=color:teal>sessions_sort</span><span style=color:#000;font-weight:700>=</span>true<span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2></span>    <span style=color:teal>monitor_username</span><span style=color:#000;font-weight:700>=</span><span style=color:#d14>&#34;monitor&#34;</span><span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2></span>    <span style=color:teal>monitor_password</span><span style=color:#000;font-weight:700>=</span><span style=color:#d14>&#34;monitor&#34;</span><span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2></span><span style=color:#000;font-weight:700>}</span><span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2></span><span style=color:teal>mysql_replication_hostgroups</span> <span style=color:#000;font-weight:700>=</span><span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2></span><span style=color:#000;font-weight:700>(</span><span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2></span>    <span style=color:#000;font-weight:700>{</span> <span style=color:teal>writer_hostgroup</span><span style=color:#000;font-weight:700>=</span><span style=color:#099>10</span> , <span style=color:teal>reader_hostgroup</span><span style=color:#000;font-weight:700>=</span><span style=color:#099>20</span> , <span style=color:teal>comment</span><span style=color:#000;font-weight:700>=</span><span style=color:#d14>&#34;host groups&#34;</span> <span style=color:#000;font-weight:700>}</span><span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2></span><span style=color:#000;font-weight:700>)</span><span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2></span><span style=color:teal>mysql_servers</span> <span style=color:#000;font-weight:700>=</span><span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2></span><span style=color:#000;font-weight:700>(</span><span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2></span>    <span style=color:#000;font-weight:700>{</span> <span style=color:teal>address</span><span style=color:#000;font-weight:700>=</span><span style=color:#d14>&#34;mysql-master&#34;</span> , <span style=color:teal>port</span><span style=color:#000;font-weight:700>=</span><span style=color:#099>3306</span> , <span style=color:teal>hostgroup</span><span style=color:#000;font-weight:700>=</span>10, <span style=color:teal>max_connections</span><span style=color:#000;font-weight:700>=</span><span style=color:#099>100</span> , <span style=color:teal>max_replication_lag</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#099>5</span> <span style=color:#000;font-weight:700>}</span>,<span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2></span>    <span style=color:#000;font-weight:700>{</span> <span style=color:teal>address</span><span style=color:#000;font-weight:700>=</span><span style=color:#d14>&#34;mysql-slave1&#34;</span> , <span style=color:teal>port</span><span style=color:#000;font-weight:700>=</span><span style=color:#099>3306</span> , <span style=color:teal>hostgroup</span><span style=color:#000;font-weight:700>=</span>20, <span style=color:teal>max_connections</span><span style=color:#000;font-weight:700>=</span><span style=color:#099>100</span> , <span style=color:teal>max_replication_lag</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#099>5</span> <span style=color:#000;font-weight:700>}</span>,<span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2></span>    <span style=color:#000;font-weight:700>{</span> <span style=color:teal>address</span><span style=color:#000;font-weight:700>=</span><span style=color:#d14>&#34;mysql-slave2&#34;</span> , <span style=color:teal>port</span><span style=color:#000;font-weight:700>=</span><span style=color:#099>3306</span> , <span style=color:teal>hostgroup</span><span style=color:#000;font-weight:700>=</span>20, <span style=color:teal>max_connections</span><span style=color:#000;font-weight:700>=</span><span style=color:#099>100</span> , <span style=color:teal>max_replication_lag</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#099>5</span> <span style=color:#000;font-weight:700>}</span><span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2></span><span style=color:#000;font-weight:700>)</span><span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2></span><span style=color:teal>mysql_query_rules</span> <span style=color:#000;font-weight:700>=</span><span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2></span><span style=color:#000;font-weight:700>(</span><span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2></span>    <span style=color:#000;font-weight:700>{</span><span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2></span>        <span style=color:teal>rule_id</span><span style=color:#000;font-weight:700>=</span><span style=color:#099>100</span><span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2></span>        <span style=color:teal>active</span><span style=color:#000;font-weight:700>=</span><span style=color:#099>1</span><span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2></span>        <span style=color:teal>match_pattern</span><span style=color:#000;font-weight:700>=</span><span style=color:#d14>&#34;^SELECT .* FOR UPDATE&#34;</span><span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2></span>        <span style=color:teal>destination_hostgroup</span><span style=color:#000;font-weight:700>=</span><span style=color:#099>10</span><span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2></span>        <span style=color:teal>apply</span><span style=color:#000;font-weight:700>=</span><span style=color:#099>1</span><span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2></span>    <span style=color:#000;font-weight:700>}</span>,<span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2></span>    <span style=color:#000;font-weight:700>{</span><span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2></span>        <span style=color:teal>rule_id</span><span style=color:#000;font-weight:700>=</span><span style=color:#099>200</span><span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2></span>        <span style=color:teal>active</span><span style=color:#000;font-weight:700>=</span><span style=color:#099>1</span><span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2></span>        <span style=color:teal>match_pattern</span><span style=color:#000;font-weight:700>=</span><span style=color:#d14>&#34;^SELECT .*&#34;</span><span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2></span>        <span style=color:teal>destination_hostgroup</span><span style=color:#000;font-weight:700>=</span><span style=color:#099>20</span><span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2></span>        <span style=color:teal>apply</span><span style=color:#000;font-weight:700>=</span><span style=color:#099>1</span><span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2></span>    <span style=color:#000;font-weight:700>}</span>,<span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2></span>    <span style=color:#000;font-weight:700>{</span><span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2></span>        <span style=color:teal>rule_id</span><span style=color:#000;font-weight:700>=</span><span style=color:#099>300</span><span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2></span>        <span style=color:teal>active</span><span style=color:#000;font-weight:700>=</span><span style=color:#099>1</span><span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2></span>        <span style=color:teal>match_pattern</span><span style=color:#000;font-weight:700>=</span><span style=color:#d14>&#34;.*&#34;</span><span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2></span>        <span style=color:teal>destination_hostgroup</span><span style=color:#000;font-weight:700>=</span><span style=color:#099>10</span><span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2></span>        <span style=color:teal>apply</span><span style=color:#000;font-weight:700>=</span><span style=color:#099>1</span><span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2></span>    <span style=color:#000;font-weight:700>}</span><span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2></span><span style=color:#000;font-weight:700>)</span><span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2></span><span style=color:teal>mysql_users</span> <span style=color:#000;font-weight:700>=</span><span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2></span><span style=color:#000;font-weight:700>(</span><span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2></span>    <span style=color:#000;font-weight:700>{</span> <span style=color:teal>username</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#d14>&#34;root&#34;</span> , <span style=color:teal>password</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#d14>&#34;password&#34;</span> , <span style=color:teal>default_hostgroup</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#099>10</span> , <span style=color:teal>active</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#099>1</span> <span style=color:#000;font-weight:700>}</span><span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2></span><span style=color:#000;font-weight:700>)</span><span style=color:#a61717;background-color:#e3d2d2>
</span></code></pre></div><p>è‰²ã€…æ›¸ã‹ã‚Œã¦ã„ã‚‹ã‘ã©ã€ã¾ãš<code>mysql_replication_hostgroups</code> ã§master / slaveã®ãƒ›ã‚¹ãƒˆã‚°ãƒ«ãƒ¼ãƒ—ã‚’è¨­å®šã—ã€å®Ÿéš›ã®æ¥ç¶šæƒ…å ±ã‚’ <code>mysql_servers</code> ã«è¨˜è¿°ã—ã¦ã„ã‚‹ã€‚</p><p>ã•ã‚‰ã«ã€<code>mysql_query_rules</code> ã§ã¯ã‚¯ã‚¨ãƒªæ¯ã«ã©ã®ãƒ›ã‚¹ãƒˆã‚°ãƒ«ãƒ¼ãƒ—ã¸ã¨ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’æµã™ã®ã‹è¨˜è¿°ã§ãã‚‹ã€‚<code>SELECT</code> ã‚¯ã‚¨ãƒªã‚’slaveã«ã€ãã‚Œä»¥å¤–ã¯masterã¸ã¨é€ã‚‹ã‚ˆã†ã«è¨­å®šã—ãŸã€‚</p><p>è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ä»¥å¤–ã«å¿…è¦ãªã“ã¨ã¯ã€æ¥ç¶šå…ˆã®MySQLã§ProxySQLç”¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä½œã‚‹ã“ã¨ã€‚</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#000;font-weight:700>CREATE</span><span style=color:#bbb> </span><span style=color:#000;font-weight:700>USER</span><span style=color:#bbb> </span><span style=color:#000;font-weight:700>IF</span><span style=color:#bbb> </span><span style=color:#000;font-weight:700>NOT</span><span style=color:#bbb> </span><span style=color:#000;font-weight:700>EXISTS</span><span style=color:#bbb> </span><span style=color:#d14>&#39;monitor&#39;</span><span style=color:#000;font-weight:700>@</span><span style=color:#d14>&#39;%&#39;</span><span style=color:#bbb> </span>IDENTIFIED<span style=color:#bbb> </span><span style=color:#000;font-weight:700>BY</span><span style=color:#bbb> </span><span style=color:#d14>&#39;monitor&#39;</span>;<span style=color:#bbb>
</span></code></pre></div><p>ã¡ãªã¿ã«ã€<a href=https://proxysql.com/documentation/MySQL-8.0/>MySQL 8.0</a>ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®èªè¨¼ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã§ã‚ã‚‹ <code>caching_sha2_password</code> ã¯ProxySQLã§ã¯éå¯¾å¿œãªã®ã§ã€<code>my.cnf</code>ã«ä¸‹è¨˜ã‚’è¿½åŠ ã—ã¦ãŠãå¿…è¦ã‚‚ã‚ã‚‹ã€‚</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>[mysqld]
...
default_authentication_plugin=mysql_native_password
</code></pre></div><p>docker-compose ã«è¿½åŠ ã—ã¦ã€ProxySQLã‚’ç«‹ã¡ä¸Šã’ã¦ã¿ã‚‹ã€‚</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-docker data-lang=docker>version: <span style=color:#d14>&#34;3&#34;</span><span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2></span>services:<span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2></span>  ...<span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2></span>  proxysql:<span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2></span>    image: proxysql/proxysql:2.0.12<span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2></span>    container_name: proxysql-mysql-replication-proxysql<span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2></span>    ports:<span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2></span>      - 6032:6032<span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2></span>      - 6033:6033<span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2></span>    volumes:<span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2></span>      - ./proxysql/proxysql.cnf:/etc/proxysql.cnf<span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2></span>    depends_on:<span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2></span>      - mysql-master<span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2></span>      - mysql-slave1<span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2></span>      - mysql-slave2<span style=color:#a61717;background-color:#e3d2d2>
</span></code></pre></div><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>â¯ $ mysql -h 0.0.0.0 -P <span style=color:#099>6032</span> -u admin2 -p -e <span style=color:#d14>&#39;select * from mysql_servers&#39;</span>
  Enter password:
  +--------------+--------------+------+-----------+--------+--------+-------------+-----------------+---------------------+---------+----------------+---------+
  | hostgroup_id | hostname     | port | gtid_port | status | weight | compression | max_connections | max_replication_lag | use_ssl | max_latency_ms | comment |
  +--------------+--------------+------+-----------+--------+--------+-------------+-----------------+---------------------+---------+----------------+---------+
  | <span style=color:#099>10</span>           | mysql-master | <span style=color:#099>3306</span> | <span style=color:#099>0</span>         | ONLINE | <span style=color:#099>1</span>      | <span style=color:#099>0</span>           | <span style=color:#099>100</span>             | <span style=color:#099>5</span>                   | <span style=color:#099>0</span>       | <span style=color:#099>0</span>              |         |
  | <span style=color:#099>20</span>           | mysql-slave1 | <span style=color:#099>3306</span> | <span style=color:#099>0</span>         | ONLINE | <span style=color:#099>1</span>      | <span style=color:#099>0</span>           | <span style=color:#099>100</span>             | <span style=color:#099>5</span>                   | <span style=color:#099>0</span>       | <span style=color:#099>0</span>              |         |
  | <span style=color:#099>20</span>           | mysql-slave2 | <span style=color:#099>3306</span> | <span style=color:#099>0</span>         | ONLINE | <span style=color:#099>1</span>      | <span style=color:#099>0</span>           | <span style=color:#099>100</span>             | <span style=color:#099>5</span>                   | <span style=color:#099>0</span>       | <span style=color:#099>0</span>              |         |
  +--------------+--------------+------+-----------+--------+--------+-------------+-----------------+---------------------+---------+----------------+---------+
</code></pre></div><p>ãã¡ã‚“ã¨masterã¨slaveãŒèªè­˜ã•ã‚Œã¦ã„ã‚‹ï¼ã‚ã¨ã¯ã€ProxySQLã®6033ãƒãƒ¼ãƒˆã‚’DBã®å®›å…ˆã¨ã—ã¦ä½¿ãˆã°ã‚ªãƒƒã‚±ãƒ¼ ğŸ‰</p><h2 id=sysbenchã§è² è·ã‚’ã‹ã‘ã¦ã¿ã‚‹>sysbenchã§è² è·ã‚’ã‹ã‘ã¦ã¿ã‚‹</h2><p>ã“ã“ã¾ã§ProxySQLã‚’ä½¿ã£ã¦è¤‡æ•°DBã‚’æ‰±ãˆã¦ã„ã‚‹ã®ã§ã€<a href=https://github.com/akopytov/sysbench>sysbench</a>ã§ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ã‚’å–ã£ã¦ã¿ã‚‹ã€‚åŒæ™‚ã«ã€è² è·åˆ†æ•£ãŒè¡Œã‚ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã™ã‚‹ãŸã‚ã«ã€<a href=https://github.com/prometheus/mysqld_exporter>mysqld-exporter</a> ã‚’ä½¿ã£ã¦MySQLã®å„ç¨®ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’<a href=https://prometheus.io/>Prometheus</a>ã§å–å¾—ã—ã€<a href=https://grafana.com/>Grafana</a>ã§å¯è¦–åŒ–ã—ã¦ã¿ã‚‹ã€‚</p><p>ã“ã‚Œã‚‰ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã«ã¤ã„ã¦ã¯æœ¬ç­‹ã‹ã‚‰é€¸ã‚Œã‚‹ã®ã§å‰²æ„›ã™ã‚‹ã€‚ç°¡å˜ã«èª¬æ˜ã™ã‚‹ã¨ã€mysqld-exporterã‚’ã™ã¹ã¦ã®MySQLã«è¨­å®šã—ã€Prometheusã®targetã¨ã—ã¦ç™»éŒ²ã€ã‚ã¨ã¯Grafanaã‹ã‚‰Prometheusã®ãƒ‡ãƒ¼ã‚¿ã‚’importã™ã‚Œã°ã‚ˆã„ã€‚è©³ç´°ã¯ã‚³ãƒ¼ãƒ‰ã‚’è¦‹ã¦ã»ã—ã„ã€‚</p><p>ã¾ãŸã€Grafanaã®ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã¯ <a href=https://github.com/percona/grafana-dashboards>percona/grafana-dashboards</a> ã«è‰¯ã„æ„Ÿã˜ã®ã‚‚ã®ãŒä¸ŠãŒã£ã¦ã„ã‚‹ã®ã§ã€ã‚ã‚ŠãŒãŸãä½¿ã‚ã›ã¦ã„ãŸã ãã€‚<a href=https://github.com/percona/grafana-dashboards/blob/master/dashboards/MySQL_Overview.json>MySQL_Overview</a> ã‚’ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã¨ã€åˆæœŸçŠ¶æ…‹ã¯ã“ã‚“ãªæ„Ÿã˜ã€‚ProxySQLã®monitorãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã®ã‚¢ã‚¯ã‚»ã‚¹ã ã‚ã†ã‹ã€QPSã¯4å‰å¾Œã‚’æ¨ç§»ã—ã¦ã„ã‚‹ã€‚</p><div style=text-align:center><figure style="margin:30px 0"><a class=dont-hightlight href=https://user-images.githubusercontent.com/13511520/83348222-73ea9800-a365-11ea-9162-acf5c99c76e5.png target=_blank><img loading=lazy src=https://user-images.githubusercontent.com/13511520/83348222-73ea9800-a365-11ea-9162-acf5c99c76e5.png alt=master width=100%></a><figcaption></figcaption></figure></div><p>ã¾ãšã¯ã€masterã® <code>sb_test</code> ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«å¯¾ã—ã€ãƒ†ãƒ¼ãƒ–ãƒ«æ•°10ã€å„10000å€‹ã®ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆã™ã‚‹ã€‚</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>â¯ sysbench --db-driver<span style=color:#000;font-weight:700>=</span>mysql <span style=color:#d14>\
</span><span style=color:#d14></span>        --mysql-host<span style=color:#000;font-weight:700>=</span>0.0.0.0 <span style=color:#d14>\
</span><span style=color:#d14></span>        --mysql-port<span style=color:#000;font-weight:700>=</span><span style=color:#099>6033</span> <span style=color:#d14>\
</span><span style=color:#d14></span>        --mysql-user<span style=color:#000;font-weight:700>=</span>root <span style=color:#d14>\
</span><span style=color:#d14></span>        --mysql-password<span style=color:#000;font-weight:700>=</span>password <span style=color:#d14>\
</span><span style=color:#d14></span>        --mysql-db<span style=color:#000;font-weight:700>=</span>sbtest <span style=color:#d14>\
</span><span style=color:#d14></span>        --threads<span style=color:#000;font-weight:700>=</span><span style=color:#099>10</span> <span style=color:#d14>\
</span><span style=color:#d14></span>        --tables<span style=color:#000;font-weight:700>=</span><span style=color:#099>10</span> <span style=color:#d14>\
</span><span style=color:#d14></span>        --table-size<span style=color:#000;font-weight:700>=</span><span style=color:#099>10000</span> <span style=color:#d14>\
</span><span style=color:#d14></span>        oltp_read_only <span style=color:#d14>\
</span><span style=color:#d14></span>        prepare
</code></pre></div><p>ä»Šå›ã¯ã€ProxySQLã§DBæ§‹æˆã‚’å¤‰æ›´ã—ãªãŒã‚‰ã€æ¬¡ã®ã‚ˆã†ãª4ã¤ã®ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ã‚’å–ã£ã¦ã¿ãŸã€‚</p><ol><li>masterå˜ä½“ã«å¯¾ã—ã¦ã€åŒæ™‚æ¥ç¶šæ•°100ã§1åˆ†é–“readã‚¯ã‚¨ãƒªã‚’ã‹ã‘ã‚‹</li><li>masterå˜ä½“ã«å¯¾ã—ã¦ã€åŒæ™‚æ¥ç¶šæ•°50ã§1åˆ†é–“readã‚¯ã‚¨ãƒªã‚’ã‹ã‘ã‚‹</li><li>master + slave x2 ã«å¯¾ã—ã¦ã€åŒæ™‚æ¥ç¶šæ•°100ã§1åˆ†é–“readã‚¯ã‚¨ãƒªã‚’ã‹ã‘ã‚‹</li><li>master + slave x2 ã«å¯¾ã—ã¦ã€åŒæ™‚æ¥ç¶šæ•°60ã§1åˆ†é–“readã‚¯ã‚¨ãƒªã‚’ã‹ã‘ã‚‹</li></ol><p>ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ã®ã‚³ãƒãƒ³ãƒ‰ä¾‹ã€‚</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>â¯ sysbench --db-driver<span style=color:#000;font-weight:700>=</span>mysql <span style=color:#d14>\
</span><span style=color:#d14></span>        --mysql-host<span style=color:#000;font-weight:700>=</span>0.0.0.0 <span style=color:#d14>\
</span><span style=color:#d14></span>        --mysql-port<span style=color:#000;font-weight:700>=</span><span style=color:#099>6033</span> <span style=color:#d14>\
</span><span style=color:#d14></span>        --mysql-user<span style=color:#000;font-weight:700>=</span>root <span style=color:#d14>\
</span><span style=color:#d14></span>        --mysql-password<span style=color:#000;font-weight:700>=</span>password <span style=color:#d14>\
</span><span style=color:#d14></span>        --mysql-db<span style=color:#000;font-weight:700>=</span>sbtest <span style=color:#d14>\
</span><span style=color:#d14></span>        --threads<span style=color:#000;font-weight:700>=</span>&lt;åŒæ™‚æ¥ç¶šæ•°&gt; <span style=color:#d14>\
</span><span style=color:#d14></span>        --time<span style=color:#000;font-weight:700>=</span>&lt;æ™‚é–“<span style=color:#000;font-weight:700>[</span>s<span style=color:#000;font-weight:700>]</span>ï¼ <span style=color:#d14>\
</span><span style=color:#d14></span>        oltp_read_only <span style=color:#d14>\
</span><span style=color:#d14></span>        run
</code></pre></div><p>ã™ã‚‹ã¨ã€çµæœã¯æ¬¡ã®ã‚ˆã†ã«ãªã£ãŸã€‚ï¼ˆè©³ç´°ã¯æœ€å¾Œã«è¨˜è¼‰ï¼‰</p><ol><li>MaxConnectionã‚’è¶…ãˆãŸãŸã‚ã‚¨ãƒ©ãƒ¼</li><li>æˆåŠŸï¼ˆAverage Latency= 643.54 [ms]ï¼‰</li><li>æˆåŠŸï¼ˆAverage Latency = 1825.77 [ms]ï¼‰</li><li>æˆåŠŸï¼ˆAverage Latency = 917.97 [ms]ï¼‰</li></ol><p>ã©ã†ã‚„ã‚‰ã€ä»Šå›ã®dockerç’°å¢ƒã§ã¯ã€masterå˜ä½“ã§ã¯åŒæ™‚æ¥ç¶šæ•°100ã¯è€ãˆã‚‰ã‚Œãªã„ã‚‰ã—ã„ã€‚ã—ã‹ã—ã€slave2ã¤ã‚’åŠ ãˆãŸæ§‹æˆã«ã™ã‚‹ã“ã¨ã§è€ãˆã‚‹ã“ã¨ãŒå‡ºæ¥ãŸã€‚</p><p>ã¡ãªã¿ã«ã€1ã®ã‚¨ãƒ©ãƒ¼ã®åŸå› ã ãŒã€MaxConnectionsã¯151ã«è¨­å®šã•ã‚Œã¦ãŠã‚Šã€ã“ã‚Œã‚’è¶…ãˆãŸã“ã¨ãŒGrafanaã§ã‚‚ç¢ºèªã§ããŸã€‚ï¼ˆãªãœåŒæ™‚æ¥ç¶šæ•°100ã®ãƒ™ãƒ³ãƒã§ãã“ã¾ã§å¤§ããªå€¤ã‚’ã¨ã‚‹ã®ã‹è¬ã§èª¿ã¹ã¦ã¿ãŸãŒã€ã‚ã‹ã‚‰ãªã‹ã£ãŸã€‚ã¨ã«ã‹ãProxySQLã‚’ä»‹ã™ã‚‹ã¨æœ¬æ¥ã®æ¥ç¶šæ•°ã®2å€è¿‘ã„å€¤ãŒå‡ºã¦ã—ã¾ã†ã‚ˆã†ã ã€‚Connection PoolãŒã†ã¾ãå†åˆ©ç”¨ã§ãã¦ã„ãªã„ã®ã ã‚ã†ã‹â€¦ï¼Ÿè¦èª¿æŸ»ï¼‰</p><p>MaxConnectionã®å€¤ã¯å¤‰æ›´å¯èƒ½ã ãŒã€ä»Šå›ã“ã‚Œã‚’é™ç•Œã ã¨æ‰ãˆã‚Œã°ã€å†—é•·åŒ–ã«ã‚ˆã£ã¦ã‚ˆã‚Šå¤šãã®åŒæ™‚ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’æŒã‘ãŸã¨è¨€ãˆã‚‹ã€‚Slaveã«ã‚‚ãã¡ã‚“ã¨ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒé£›ã‚“ã§ã„ã‚‹ã®ãŒç¢ºèªã§ããŸã€‚</p><ul><li><p>master<div style=text-align:center><figure style="margin:30px 0"><a class=dont-hightlight href=https://user-images.githubusercontent.com/13511520/83347951-a5626400-a363-11ea-9d60-dfd75c12ee28.png target=_blank><img loading=lazy src=https://user-images.githubusercontent.com/13511520/83347951-a5626400-a363-11ea-9d60-dfd75c12ee28.png alt=master width=90%></a><figcaption></figcaption></figure></div></p></li><li><p>slave1<div style=text-align:center><figure style="margin:30px 0"><a class=dont-hightlight href=#ZgotmplZ target=_blank><img loading=lazy src=https://user-images.githubusercontent.com/13511520/83347954-a7c4be00-a363-11ea-87b8-b1d7466d2b5e.png alt=master width=90%></a><figcaption></figcaption></figure></div></p></li><li><p>slave2</p><div style=text-align:center><figure style="margin:30px 0"><a class=dont-hightlight href=https://user-images.githubusercontent.com/13511520/83347956-aa271800-a363-11ea-942e-a13efcd58128.png target=_blank><img loading=lazy src=https://user-images.githubusercontent.com/13511520/83347956-aa271800-a363-11ea-942e-a13efcd58128.png alt=master width=90%></a><figcaption></figcaption></figure></div></li></ul><p>ã¡ãªã¿ã«ã€Grafanaã®ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã¯ç°¡å˜ã«snapshotãŒå–ã‚ŒãŸã®ã§æ²è¼‰ã—ã¦ãŠãã€‚</p><ul><li><a href="https://snapshot.raintank.io/dashboard/snapshot/Ve4OefZud4ZchPoYuyrZCYnrKQ8fJIEw?orgId=2">masterã®ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</a></li><li><a href="https://snapshot.raintank.io/dashboard/snapshot/j8iLJRXhnz0JGMn5Zl5onpLS66Yfs73x?orgId=2">slave1ã®ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</a></li><li><a href="https://snapshot.raintank.io/dashboard/snapshot/IEH258Pt3AXPYWOlMKZ4eFz55nwxaVdS?orgId=2&refresh=5s">slave2ã®ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</a></li></ul><h2 id=ãŠã‚ã‚Šã«>ãŠã‚ã‚Šã«</h2><p>ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‹ã‚‰ä½¿ã†å ´åˆã‚’æƒ³å®šã—ã¦ã€MySQLã®master-slaveãƒãƒ¼ãƒ‰ã‚’ProxySQLã§ä½¿ã†æ§‹æˆã‚’è©¦ã—ã¦ã¿ãŸã€‚ProxySQLã¯ç°¡å˜ã«ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã§ãã¦æ§˜ã€…ãªæ©æµã‚’å—ã‘ã‚‰ã‚Œã‚‹ã‚‚ã®ã®ã€å®Ÿç”¨ã§ã¯ã“ã‚Œè‡ªä½“ã®ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°ã‚„ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼åŒ–ã‚’ã—ã¦ã„ã‹ãªã„ã¨ã€æ–°ãŸãªãƒœãƒˆãƒ«ãƒãƒƒã‚¯ãŒç”Ÿã¾ã‚Œãã†ãªæ°—ã‚‚ã™ã‚‹ã€‚</p><p>æ¬¡ã¯æ™‚é–“ãŒã‚ã£ãŸã‚‰failoverã«ã¤ã„ã¦èª¿ã¹ã¦ã¿ãŸã„ã€‚</p><div style=text-align:center><figure style="margin:30px 0"><a class=dont-hightlight href=https://github.com/raahii/proxysql-mysql-replication target=_blank><img loading=lazy src=https://user-images.githubusercontent.com/13511520/83348184-1bb39600-a365-11ea-9fe9-768be9470fc8.png alt="repo image" width=60%></a><figcaption></figcaption></figure></div><h2 id=appendix>Appendix</h2><p>sysbenchã®è©³ç´°ãªçµæœã€‚</p><ol><li>masterå˜ä½“ã«å¯¾ã—ã¦ã€åŒæ™‚æ¥ç¶šæ•°100ã§1åˆ†é–“</li></ol><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>FATAL: mysql_stmt_execute() returned error 9001 (Max connect timeout reached while reaching hostgroup 20 after 10004ms) for query &#39;SELECT SUM(k) FROM sbtest1 WHERE id BETWEEN ? AND ?&#39;
FATAL: mysql_stmt_execute() returned error 9001 (Max connect timeout reached while reaching hostgroup 20 after 10004ms) for query &#39;SELECT c FROM sbtest1 WHERE id=?&#39;
FATAL: `thread_run&#39; function failed: ...al/Cellar/sysbench/1.0.20/share/sysbench/oltp_common.lua:419: SQL error, errno = 9001, state = &#39;HY000&#39;: Max connect timeout reached while reaching hostgroup 20 after 10004ms
FATAL: `thread_run&#39; function failed: ...al/Cellar/sysbench/1.0.20/share/sysbench/oltp_common.lua:432: SQL error, errno = 9001, state = &#39;HY000&#39;: Max connect timeout reached while reaching hostgroup 20 after 10004ms
FATAL: mysql_stmt_execute() returned error 9001 (Max connect timeout reached while reaching hostgroup 20 after 10009ms) for query &#39;SELECT c FROM sbtest1 WHERE id=?&#39;
(last message repeated 1 times)
FATAL: `thread_run&#39; function failed: ...al/Cellar/sysbench/1.0.20/share/sysbench/oltp_common.lua:419: SQL error, errno = 9001, state = &#39;HY000&#39;: Max connect timeout reached while reaching hostgroup 20 after 10009ms
FATAL: mysql_stmt_execute() returned error 9001 (Max connect timeout reached while reaching hostgroup 20 after 10009ms) for query &#39;SELECT c FROM sbtest1 WHERE id=?&#39;
FATAL: `thread_run&#39; function failed: ...al/Cellar/sysbench/1.0.20/share/sysbench/oltp_common.lua:419: SQL error, errno = 9001, state = &#39;HY000&#39;: Max connect timeout reached while reaching hostgroup 20 after 10009ms
(last message repeated 1 times)
FATAL: mysql_stmt_execute() returned error 9001 (Max connect timeout reached while reaching hostgroup 20 after 10000ms) for query &#39;SELECT c FROM sbtest1 WHERE id BETWEEN ? AND ?&#39;
FATAL: `thread_run&#39; function failed: ...al/Cellar/sysbench/1.0.20/share/sysbench/oltp_common.lua:432: SQL error, errno = 9001, state = &#39;HY000&#39;: Max connect timeout reached while reaching hostgroup 20 after 10000ms
</code></pre></div><ol start=2><li>masterå˜ä½“ã«å¯¾ã—ã¦ã€åŒæ™‚æ¥ç¶šæ•°50ã§1åˆ†é–“</li></ol><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>SQL statistics:
    queries performed:
        read:                            65422
        write:                           0
        other:                           9346
        total:                           74768
    transactions:                        4673   (77.50 per sec.)
    queries:                             74768  (1240.08 per sec.)
    ignored errors:                      0      (0.00 per sec.)
    reconnects:                          0      (0.00 per sec.)

General statistics:
    total time:                          60.2910s
    total number of events:              4673

Latency (ms):
         min:                                  111.09
         avg:                                  643.54
         max:                                 3138.66
         95th percentile:                     1533.66
         sum:                              3007283.24

Threads fairness:
    events (avg/stddev):           93.4600/4.89
    execution time (avg/stddev):   60.1457/0.09
</code></pre></div><ol start=3><li>master + slave x2 ã«å¯¾ã—ã¦ã€åŒæ™‚æ¥ç¶šæ•°100ã§1åˆ†é–“</li></ol><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>SQL statistics:
    queries performed:
        read:                            46298
        write:                           0
        other:                           6614
        total:                           52912
    transactions:                        3307   (54.54 per sec.)
    queries:                             52912  (872.63 per sec.)
    ignored errors:                      0      (0.00 per sec.)
    reconnects:                          0      (0.00 per sec.)

General statistics:
    total time:                          60.6335s
    total number of events:              3307

Latency (ms):
         min:                                  213.29
         avg:                                 1825.77
         max:                                 5333.50
         95th percentile:                     3267.19
         sum:                              6037808.20

Threads fairness:
    events (avg/stddev):           33.0700/3.55
    execution time (avg/stddev):   60.3781/0.16
</code></pre></div><ol start=4><li>master + slave x2 ã«å¯¾ã—ã¦ã€åŒæ™‚æ¥ç¶šæ•°50ã§1åˆ†é–“</li></ol><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>SQL statistics:
    queries performed:
        read:                            46354
        write:                           0
        other:                           6622
        total:                           52976
    transactions:                        3311   (53.75 per sec.)
    queries:                             52976  (859.98 per sec.)
    ignored errors:                      0      (0.00 per sec.)
    reconnects:                          0      (0.00 per sec.)

General statistics:
    total time:                          61.5994s
    total number of events:              3311

Latency (ms):
         min:                                  133.54
         avg:                                  917.97
         max:                                 3431.71
         95th percentile:                     2159.29
         sum:                              3039408.90

Threads fairness:
    events (avg/stddev):           66.2200/8.72
    execution time (avg/stddev):   60.7882/0.55
</code></pre></div></div></article><div id=disqus_thread></div><script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return}var b=document,a=b.createElement('script');a.async=!0,a.src='//raahii.disqus.com/embed.js',a.setAttribute('data-timestamp',+new Date),(b.head||b.body).appendChild(a)})()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a><h3>ã“ã¡ã‚‰ã®è¨˜äº‹ã‚‚ã©ã†ã</h3><ul class="related-content article-content"><li><a href=/posts/docker-mysql-master-slave-replication/>MySQLã®master slaveæ§‹æˆã‚’Dockerã§è©¦ã™</a></li><li><a href=/posts/vim-ale-sql-formatter/>Vim ALE ã¨ sql-formatter ã§ SQL ã‚’æ•´å½¢ã™ã‚‹</a></li></ul></main><footer class=footer><ul class=footer-links><li><a href=https://gohugo.io/ class=footer-links-kudos>Made with <img src=https://raahii.github.io/images/hugo-logo.png width=22 height=22 alt="hugo log"></a></li></ul></footer></div><script async src="https://www.googletagmanager.com/gtag/js?id=G-D4N0KPT2K2"></script><script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-D4N0KPT2K2',{anonymize_ip:!1})}</script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.10.1/dist/katex.min.css integrity=sha384-dbVIfZGuN1Yq7/1Ocstc1lUEm+AT+/rCkibIcC/OmWo5f0EA48Vf8CytHzGrSwbQ crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.10.1/dist/katex.min.js integrity=sha384-2BKqo+exmr9su6dir+qCw08N2ZKRucY4PrGQPPWU1A7FtlCGjmEGFqXCv5nyM5Ij crossorigin=anonymous></script><script defer src=https://cdn.jsdelivr.net/npm/katex@0.10.1/dist/contrib/auto-render.min.js integrity=sha384-kWPLUVMOks5AQFrykwIup5lo0m3iMkkHrD0uJ4H5cjeGihAutqP0yW0J6dpFiVkI crossorigin=anonymous onload=renderMathInElement(document.body)></script><script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}]})})</script></body></html>