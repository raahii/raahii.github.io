<!doctype html><html lang=ja-jp><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=generator content="Hugo 0.85.0"><title>MySQLのmaster slave構成をDockerで試す</title><link rel=canonical href=https://raahii.me/posts/docker-mysql-master-slave-replication/><meta http-equiv=refresh content="0; url=https://raahii.me/posts/docker-mysql-master-slave-replication/"><link href=https://raahii.github.io/favicon.ico rel=icon type=image/x-icon><meta property="description" content="MySQLのmaster slave構成をDockerで試す"><meta property="keywords" content="mysql, master slave, replication, docker, docker-compose"><meta property="og:title" content="MySQLのmaster slave構成をDockerで試す"><meta property="og:description" content="MySQLのmaster slave構成をDockerで試す"><meta property="og:type" content="article"><meta property="og:url" content="https://raahii.github.io/posts/docker-mysql-master-slave-replication/"><meta property="og:image" content="https://miro.medium.com/max/900/1*5JgbHNxldQcCocld6mfEkQ.jpeg"><meta property="article:section" content="post"><meta property="article:published_time" content="2020-05-28T23:43:16+09:00"><meta property="article:modified_time" content="2020-05-28T23:43:16+09:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://miro.medium.com/max/900/1*5JgbHNxldQcCocld6mfEkQ.jpeg"><meta name=twitter:title content="MySQLのmaster slave構成をDockerで試す"><meta name=twitter:description content="MySQLのmaster slave構成をDockerで試す"><link rel=icon href=https://raahii.github.io/images/favicon.ico type=image/x-icon><link rel=stylesheet href=https://raahii.github.io/css/main.css media=all><link rel=stylesheet href="//fonts.googleapis.com/css?family=Merriweather:400|Lato:400,400italic,700"></head><body><div class=wrapper><header class=header><nav class=nav><a href=https://raahii.github.io/ class=nav-logo><img src=https://raahii.github.io/images/bird.svg width=45 height=45 alt=Logo><p class=nav-title>1ミリもわからん</p></a><ul class=nav-links><li><a href=/tags/>Tags</a></li><li><a href=/about/>About</a></li><li><a href=https://github.com/raahii target=_blank>GitHub</a></li><li><a href=https://twitter.com/raahiiy target=_blank>Twitter</a></li></ul></nav></header><main class=content role=main><article class=article><h1 class=article-title>MySQLのmaster slave構成をDockerで試す</h1><span class=article-date>May 28, 2020</span>
<span class=article-duration>2 min read</span><ul class="cp_tag01 article-categories">Categories:<li><a href=/categories/%E6%8A%80%E8%A1%93/>技術</a></li></ul><ul class="cp_tag01 article-tags">Tags:<li><a href=/tags/mysql/>mysql</a></li><li><a href=/tags/database/>database</a></li><li><a href=/tags/web/>web</a></li><li><a href=/tags/docker/>docker</a></li></ul><div class=article-content><p>研修で触ったときにサクッと動かなかったので追試的に。MySQLは8.0を使う。</p><div style=text-align:center><figure style="margin:30px 0"><a class=dont-hightlight href=https://github.com/raahii/docker-mysql-master-slave target=_blank><img loading=lazy src=https://user-images.githubusercontent.com/13511520/83156887-ec6f1000-a13d-11ea-80d7-cb4619751706.png alt="repo image" width=60%></a><figcaption></figcaption></figure></div><p>レプリケーション自体の仕組みは <a href=https://www.slideshare.net/yoyamasaki/mysqlmysql>進化を続けるMySQLのド定番機能　MySQLレプリケーション最新機能</a> がわかりやすかった。</p><h2 id=必要なこと>必要なこと</h2><p><a href=https://www.digitalocean.com/community/tutorials/how-to-set-up-master-slave-replication-in-mysql>How To Set Up Master Slave Replication in MySQL | DigitalOcean</a></p><p>このページを見ながらmasterとslaveのmysqldを1つずつ用意して、設定を行う。異なる点は下記。</p><ul><li><p>master, slave共に <code>bind-address</code>を<code>0.0.0.0</code>として、dockerのネットワークエイリアスで繋ぐ</p></li><li><p>masterのMySQLにレプリケーション用のユーザーを作成するが、<a href=https://www7390uo.sakura.ne.jp/wordpress/archives/456>MySQL8.0ではGRANT構文でユーザを作成できない</a> ので下記のようにする</p></li></ul><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>create user &#39;slave_user&#39;@&#39;%&#39; identified by &#39;password&#39;;
grant replication slave on *.* to &#39;slave_user&#39;@&#39;%&#39; with grant option;
flush privileges;
</code></pre></div><ul><li>GTIDを有効にして <code>MASTER_LOG_FILE</code> と <code>MASTER_LOG_POS</code> は自動で検知されるようにする。</li></ul><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>CHANGE MASTER TO MASTER_HOST=&#39;mysql-master&#39;,MASTER_USER=&#39;slave_user&#39;,MASTER_PASSWORD=&#39;password&#39;,MASTER_AUTO_POSITION=1;
START SLAVE;
</code></pre></div><h2 id=レプリケーションを確認する>レプリケーションを確認する</h2><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>$ git clone https://github.com/raahii/docker-mysql-master-slave.git
$ <span style=color:#0086b3>cd</span> docker-mysql-master-slave
$ docker-compose up -d
</code></pre></div><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>$ docker-compose ps
    Name                 Command             State                 Ports
--------------------------------------------------------------------------------------
mysql-master   docker-entrypoint.sh mysqld   Up      0.0.0.0:3306-&gt;3306/tcp, 33060/tcp
mysql-slave    docker-entrypoint.sh mysqld   Up      0.0.0.0:3307-&gt;3306/tcp, 33060/tcp

</code></pre></div><ul><li>masterのステータスを確認</li></ul><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>$ docker-compose <span style=color:#0086b3>exec</span> mysql-master sh -c <span style=color:#d14>&#34;export MYSQL_PWD=password; mysql -u root app -e &#39;show master status\G&#39;&#34;</span> 
*************************** 1. row ***************************
             File: mysql-bin.000001
         Position: <span style=color:#099>156</span>
     Binlog_Do_DB: app
 Binlog_Ignore_DB: 
Executed_Gtid_Set: 
</code></pre></div><ul><li>slaveのステータスを確認</li></ul><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>$ docker-compose <span style=color:#0086b3>exec</span> mysql-slave sh -c <span style=color:#d14>&#34;export MYSQL_PWD=password; mysql -u root app -e &#39;show slave status\G&#39;&#34;</span> 
*************************** 1. row ***************************
               Slave_IO_State: Waiting <span style=color:#000;font-weight:700>for</span> master to send event
                  Master_Host: mysql-master
                  Master_User: slave_user
                  Master_Port: <span style=color:#099>3306</span>
                Connect_Retry: <span style=color:#099>60</span>
              Master_Log_File: mysql-bin.000001
          Read_Master_Log_Pos: <span style=color:#099>156</span>
               Relay_Log_File: mysql-relay-bin.000004
                Relay_Log_Pos: <span style=color:#099>371</span>
        Relay_Master_Log_File: mysql-bin.000001
             Slave_IO_Running: Yes
            Slave_SQL_Running: Yes
                            :
                            :
</code></pre></div><ul><li>masterにテーブルを作ってレコードをinsert</li></ul><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>$ docker-compose <span style=color:#0086b3>exec</span> mysql-master sh -c “export <span style=color:teal>MYSQL_PWD</span><span style=color:#000;font-weight:700>=</span>password; mysql -u root app -e ‘create table code<span style=color:#000;font-weight:700>(</span>code int<span style=color:#000;font-weight:700>)</span>; insert into code values <span style=color:#000;font-weight:700>(</span>100<span style=color:#000;font-weight:700>)</span>, <span style=color:#000;font-weight:700>(</span>200<span style=color:#000;font-weight:700>)</span>’”
</code></pre></div><ul><li>変更が slave に反映されていることを確認</li></ul><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>$ docker-compose <span style=color:#0086b3>exec</span> mysql-slave sh -c <span style=color:#d14>&#34;export MYSQL_PWD=password; mysql -u root app -e &#39;select * from code \G&#39;&#34;</span>
*************************** 1. row ***************************
code: <span style=color:#099>100</span>
*************************** 2. row ***************************
code: <span style=color:#099>200</span>
</code></pre></div><p>テーブルも作られているし、レコードも入っている。良さそう。</p><h2 id=参考>参考</h2><ul><li><a href=https://qiita.com/Tocyuki/items/c224cef57493f536a941>MySQL入門　レプリケーション編 - Qiita</a></li><li><a href=http://nippondanji.blogspot.com/2014/12/mysqlgtid.html>漢(オトコ)のコンピュータ道: MySQLレプリケーションの運用が劇的変化！！GTIDについて仕組みから理解する</a></li></ul></div></article><div id=disqus_thread></div><script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return}var b=document,a=b.createElement('script');a.async=!0,a.src='//raahii.disqus.com/embed.js',a.setAttribute('data-timestamp',+new Date),(b.head||b.body).appendChild(a)})()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a><h3>こちらの記事もどうぞ</h3><ul class="related-content article-content"><li><a href=/posts/vim-ale-sql-formatter/>Vim ALE と sql-formatter で SQL を整形する</a></li><li><a href=/posts/docker-proxysql-mysql-replication/>ProxySQLでMySQLの負荷分散をする</a></li></ul></main><footer class=footer><ul class=footer-links><li><a href=https://gohugo.io/ class=footer-links-kudos>Made with <img src=https://raahii.github.io/images/hugo-logo.png width=22 height=22 alt="hugo log"></a></li></ul></footer></div><script async src="https://www.googletagmanager.com/gtag/js?id=G-D4N0KPT2K2"></script><script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-D4N0KPT2K2',{anonymize_ip:!1})}</script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.10.1/dist/katex.min.css integrity=sha384-dbVIfZGuN1Yq7/1Ocstc1lUEm+AT+/rCkibIcC/OmWo5f0EA48Vf8CytHzGrSwbQ crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.10.1/dist/katex.min.js integrity=sha384-2BKqo+exmr9su6dir+qCw08N2ZKRucY4PrGQPPWU1A7FtlCGjmEGFqXCv5nyM5Ij crossorigin=anonymous></script><script defer src=https://cdn.jsdelivr.net/npm/katex@0.10.1/dist/contrib/auto-render.min.js integrity=sha384-kWPLUVMOks5AQFrykwIup5lo0m3iMkkHrD0uJ4H5cjeGihAutqP0yW0J6dpFiVkI crossorigin=anonymous onload=renderMathInElement(document.body)></script><script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}]})})</script></body></html>