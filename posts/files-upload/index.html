<!doctype html><html lang=ja-jp><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=generator content="Hugo 0.85.0"><title>画像データをサーバーにPOSTする - 1ミリもわからん</title><link rel=canonical href=https://raahii.github.io/posts/files-upload/><link href=https://raahii.github.io/favicon.ico rel=icon type=image/x-icon><meta property="description" content="画像データをサーバーにPOSTする"><meta property="og:title" content="画像データをサーバーにPOSTする"><meta property="og:description" content="画像データをサーバーにPOSTする"><meta property="og:type" content="article"><meta property="og:url" content="https://raahii.github.io/posts/files-upload/"><meta property="article:section" content="post"><meta property="article:published_time" content="2019-08-04T04:13:59+09:00"><meta property="article:modified_time" content="2019-08-04T04:13:59+09:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="画像データをサーバーにPOSTする"><meta name=twitter:description content="画像データをサーバーにPOSTする"><link rel=icon href=https://raahii.github.io/images/favicon.ico type=image/x-icon><link rel=stylesheet href=https://raahii.github.io/css/main.css media=all><link rel=stylesheet href="//fonts.googleapis.com/css?family=Merriweather:400|Lato:400,400italic,700"></head><body><div class=wrapper><header class=header><nav class=nav><a href=https://raahii.github.io/ class=nav-logo><img src=https://raahii.github.io/images/bird.svg width=45 height=45 alt=Logo><p class=nav-title>1ミリもわからん</p></a><ul class=nav-links><li><a href=/tags/>Tags</a></li><li><a href=/about/>About</a></li><li><a href=https://github.com/raahii target=_blank>GitHub</a></li><li><a href=https://twitter.com/raahiiy target=_blank>Twitter</a></li></ul></nav></header><main class=content role=main><article class=article><h1 class=article-title>画像データをサーバーにPOSTする</h1><span class=article-date>August 4, 2019</span>
<span class=article-duration>1 min read</span><ul class="cp_tag01 article-categories">Categories:<li><a href=/categories/%E6%8A%80%E8%A1%93/>技術</a></li></ul><ul class="cp_tag01 article-tags">Tags:<li><a href=/tags/python/>python</a></li><li><a href=/tags/%E6%A9%9F%E6%A2%B0%E5%AD%A6%E7%BF%92/>機械学習</a></li><li><a href=/tags/backend/>backend</a></li><li><a href=/tags/http/>http</a></li></ul><div class=article-content><p>機械学習を使ったサービス/アプリを開発しているとクライアントから画像をサーバーに送って推論して結果を返す，ということをよくやるのでメモ．</p><h2 id=1枚しか送らない場合>1枚しか送らない場合</h2><p>今の所自分はこのパターンが多いです．いくつか実現方法はあると思いますが，リクエストボディに直接画像データのバイナリを入れて送る方法がシンプルで好きです．クライアント側のコードはこんな感じ．</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#000;font-weight:700>import</span> <span style=color:#555>json</span>
<span style=color:#000;font-weight:700>import</span> <span style=color:#555>urllib.parse</span>
<span style=color:#000;font-weight:700>import</span> <span style=color:#555>urllib.request</span>

<span style=color:#998;font-style:italic># read image data</span>
f <span style=color:#000;font-weight:700>=</span> <span style=color:#0086b3>open</span>(<span style=color:#d14>&#34;example.jpg&#34;</span>, <span style=color:#d14>&#34;rb&#34;</span>)
reqbody <span style=color:#000;font-weight:700>=</span> f<span style=color:#000;font-weight:700>.</span>read()
f<span style=color:#000;font-weight:700>.</span>close()

<span style=color:#998;font-style:italic># create request with urllib</span>
url <span style=color:#000;font-weight:700>=</span> <span style=color:#d14>&#34;http://localhost:5000&#34;</span>
req <span style=color:#000;font-weight:700>=</span> urllib<span style=color:#000;font-weight:700>.</span>request<span style=color:#000;font-weight:700>.</span>Request(
    url,
    reqbody,
    method<span style=color:#000;font-weight:700>=</span><span style=color:#d14>&#34;POST&#34;</span>,
    headers<span style=color:#000;font-weight:700>=</span>{<span style=color:#d14>&#34;Content-Type&#34;</span>: <span style=color:#d14>&#34;application/octet-stream&#34;</span>},
)

<span style=color:#998;font-style:italic># send the request and print response</span>
<span style=color:#000;font-weight:700>with</span> urllib<span style=color:#000;font-weight:700>.</span>request<span style=color:#000;font-weight:700>.</span>urlopen(req) <span style=color:#000;font-weight:700>as</span> res:
    <span style=color:#0086b3>print</span>(json<span style=color:#000;font-weight:700>.</span>loads(res<span style=color:#000;font-weight:700>.</span>read()))
</code></pre></div><p>注意点として Content-Type に <code>application/octet-stream</code> を指定すると良いです．このMIMEタイプは曖昧なバイナリデータを指しており，ファイル種別を特に指定しないことを意味します（ref: <a href=https://www.iana.org/assignments/media-types/application/octet-stream>MIME type: application/octet-stream</a> ）．</p><p>urllibの場合，これを指定しないとPOSTのデフォルトのMIMEタイプである <code>application/x-www-form-urlencoded</code> となり，サーバー側で正しく受け取れないので気をつけてください．</p><p>一方でサーバー側（flaskの場合）のコードはこのようになります．画像データをOpenCVで読んで画像のshapeをjsonで返しています．</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#3c5d5d;font-weight:700>@app</span><span style=color:#000;font-weight:700>.</span>route(<span style=color:#d14>&#34;/&#34;</span>, methods<span style=color:#000;font-weight:700>=</span>[<span style=color:#d14>&#34;POST&#34;</span>])
<span style=color:#000;font-weight:700>def</span> <span style=color:#900;font-weight:700>example</span>():
    <span style=color:#998;font-style:italic># read request body as byte array</span>
    _bytes <span style=color:#000;font-weight:700>=</span> np<span style=color:#000;font-weight:700>.</span>frombuffer(request<span style=color:#000;font-weight:700>.</span>data, np<span style=color:#000;font-weight:700>.</span>uint8)
    <span style=color:#998;font-style:italic># decode the bytes to image directly</span>
    img <span style=color:#000;font-weight:700>=</span> cv2<span style=color:#000;font-weight:700>.</span>imdecode(_bytes, flags<span style=color:#000;font-weight:700>=</span>cv2<span style=color:#000;font-weight:700>.</span>IMREAD_COLOR)

    <span style=color:#000;font-weight:700>return</span> jsonify(img<span style=color:#000;font-weight:700>.</span>shape)
</code></pre></div><p>ポイントはリクエストボディのバイト列を直接OpenCVのAPIで画像として読み込んでいるところです．この部分，一度画像データをファイルに書き出してから改めて読んでいるコードをよく見かけますが，直接できます．しかもこの方法だとjpegでもpngでも関係なく画像データに落とし込めるのでとっても楽です（OpenCVが優秀なだけ？）．</p><h2 id=複数枚送る場合>複数枚送る場合</h2><p>バッチ処理なんかしたい場合は複数枚を同時に送りたいこともあると思います．その場合はやはり <code>multipart/form-data</code> だと思います（まぁそのためにあるので）．<code>multipart/form-data</code> は複数のファイルデータをBoundary文字列
で区切って連結し，送信する方法です．</p><p>ただその分，先のリクエスト方法よりも複雑なのでライブラリを使うと楽です．clientのサンプルコードです．</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#000;font-weight:700>import</span> <span style=color:#555>requests</span>

images <span style=color:#000;font-weight:700>=</span> {}
<span style=color:#000;font-weight:700>for</span> i, f <span style=color:#000;font-weight:700>in</span> <span style=color:#0086b3>enumerate</span>([<span style=color:#d14>&#34;example.jpg&#34;</span>, <span style=color:#d14>&#34;example.png&#34;</span>]):
    f <span style=color:#000;font-weight:700>=</span> <span style=color:#0086b3>open</span>(f, <span style=color:#d14>&#34;rb&#34;</span>)
    images[<span style=color:#0086b3>str</span>(i)] <span style=color:#000;font-weight:700>=</span> f<span style=color:#000;font-weight:700>.</span>read()

url <span style=color:#000;font-weight:700>=</span> <span style=color:#d14>&#34;http://localhost:5000/multi&#34;</span>
res <span style=color:#000;font-weight:700>=</span> requests<span style=color:#000;font-weight:700>.</span>post(url, files<span style=color:#000;font-weight:700>=</span>images)
<span style=color:#0086b3>print</span>(res<span style=color:#000;font-weight:700>.</span>json())
</code></pre></div><p>この場合，送りたい画像データはただの配列なのですが，どうやらdictで渡さないといけないようなので，indexを文字列にしてkeyとしました．これを使ってサーバー側のコードで順序を保証して取り出します．</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#3c5d5d;font-weight:700>@app</span><span style=color:#000;font-weight:700>.</span>route(<span style=color:#d14>&#34;/&#34;</span>, methods<span style=color:#000;font-weight:700>=</span>[<span style=color:#d14>&#34;POST&#34;</span>])
<span style=color:#000;font-weight:700>def</span> <span style=color:#900;font-weight:700>example</span>():
    <span style=color:#998;font-style:italic># sort by key as integer</span>
    files <span style=color:#000;font-weight:700>=</span> <span style=color:#0086b3>sorted</span>(request<span style=color:#000;font-weight:700>.</span>files<span style=color:#000;font-weight:700>.</span>items(), key<span style=color:#000;font-weight:700>=</span><span style=color:#000;font-weight:700>lambda</span> x: <span style=color:#0086b3>int</span>(x[<span style=color:#099>0</span>]))

    images <span style=color:#000;font-weight:700>=</span> []
    <span style=color:#000;font-weight:700>for</span> f <span style=color:#000;font-weight:700>in</span> files:
        _bytes <span style=color:#000;font-weight:700>=</span> np<span style=color:#000;font-weight:700>.</span>frombuffer(f[<span style=color:#099>1</span>]<span style=color:#000;font-weight:700>.</span>read(), np<span style=color:#000;font-weight:700>.</span>uint8)
        img <span style=color:#000;font-weight:700>=</span> cv2<span style=color:#000;font-weight:700>.</span>imdecode(_bytes, flags<span style=color:#000;font-weight:700>=</span>cv2<span style=color:#000;font-weight:700>.</span>IMREAD_COLOR)

        images<span style=color:#000;font-weight:700>.</span>append(img<span style=color:#000;font-weight:700>.</span>shape)

    <span style=color:#000;font-weight:700>return</span> jsonify(images)
</code></pre></div><p>あんまりキレイではないですが，こんな感じでできます．ちなみに，画像データ以外のjsonデータを送りたい場合なんかも同様に <code>multipart/form-data</code>を使ってできるので万能ですね．</p><h2 id=所感>所感</h2><p>覚えたぞ，<code>application/octet-stream</code>．</p></div></article><div id=disqus_thread></div><script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return}var b=document,a=b.createElement('script');a.async=!0,a.src='//raahii.disqus.com/embed.js',a.setAttribute('data-timestamp',+new Date),(b.head||b.body).appendChild(a)})()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a><h3>こちらの記事もどうぞ</h3><ul class="related-content article-content"><li><a href=/posts/add-video-method-for-tensorboard-chainer/>tensorboard-chainerにビデオを記録するためのPRを出した</a></li><li><a href=/posts/nvidia-driver-not-work-after-reboot-on-ubuntu/>Ubuntu16.04でnvidiaドライバが再起動の度に無効になる</a></li><li><a href=/posts/dvdgan-adversarial-video-generation-on-complex-datasets/>DVDGAN - "Adversarial Video Generation on Complex Datasets"</a></li><li><a href=/posts/conditional-batch-normalization/>Conditional Batch Normalizationについて</a></li><li><a href=/posts/chainer-implementation-3dgan/>3DGANをchainerで実装した</a></li></ul></main><footer class=footer><ul class=footer-links><li><a href=https://gohugo.io/ class=footer-links-kudos>Made with <img src=https://raahii.github.io/images/hugo-logo.png width=22 height=22 alt="hugo log"></a></li></ul></footer></div><script async src="https://www.googletagmanager.com/gtag/js?id=G-D4N0KPT2K2"></script><script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-D4N0KPT2K2',{anonymize_ip:!1})}</script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.10.1/dist/katex.min.css integrity=sha384-dbVIfZGuN1Yq7/1Ocstc1lUEm+AT+/rCkibIcC/OmWo5f0EA48Vf8CytHzGrSwbQ crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.10.1/dist/katex.min.js integrity=sha384-2BKqo+exmr9su6dir+qCw08N2ZKRucY4PrGQPPWU1A7FtlCGjmEGFqXCv5nyM5Ij crossorigin=anonymous></script><script defer src=https://cdn.jsdelivr.net/npm/katex@0.10.1/dist/contrib/auto-render.min.js integrity=sha384-kWPLUVMOks5AQFrykwIup5lo0m3iMkkHrD0uJ4H5cjeGihAutqP0yW0J6dpFiVkI crossorigin=anonymous onload=renderMathInElement(document.body)></script><script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}]})})</script></body></html>