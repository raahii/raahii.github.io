<!doctype html><html lang=ja-jp><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=generator content="Hugo 0.85.0"><title>Vim ALE と sql-formatter で SQL を整形する</title><link rel=canonical href=https://raahii.me/posts/vim-ale-sql-formatter/><link href=https://raahii.github.io/favicon.ico rel=icon type=image/x-icon><meta property="description" content="Vim ALE と sql-formatter で SQL を整形する"><meta property="keywords" content="Neovim, sql-formatter, vim, ALE, フォーマッター"><meta property="og:title" content="Vim ALE と sql-formatter で SQL を整形する"><meta property="og:description" content="Vim ALE と sql-formatter で SQL を整形する"><meta property="og:type" content="article"><meta property="og:url" content="https://raahii.github.io/posts/vim-ale-sql-formatter/"><meta property="og:image" content="https://user-images.githubusercontent.com/3518142/59195920-2c339500-8b85-11e9-9c22-f6b7f69637b8.jpg"><meta property="article:section" content="post"><meta property="article:published_time" content="2022-09-20T00:30:00+09:00"><meta property="article:modified_time" content="2022-09-20T00:30:00+09:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://user-images.githubusercontent.com/3518142/59195920-2c339500-8b85-11e9-9c22-f6b7f69637b8.jpg"><meta name=twitter:title content="Vim ALE と sql-formatter で SQL を整形する"><meta name=twitter:description content="Vim ALE と sql-formatter で SQL を整形する"><link rel=icon href=https://raahii.github.io/images/favicon.ico type=image/x-icon><link rel=stylesheet href=https://raahii.github.io/css/main.css media=all><link rel=stylesheet href="//fonts.googleapis.com/css?family=Merriweather:400|Lato:400,400italic,700"></head><body><div class=wrapper><header class=header><nav class=nav><a href=https://raahii.github.io/ class=nav-logo><img src=https://raahii.github.io/images/bird.svg width=45 height=45 alt=Logo><p class=nav-title>1ミリもわからん</p></a><ul class=nav-links><li><a href=/tags/>Tags</a></li><li><a href=/about/>About</a></li><li><a href=https://github.com/raahii target=_blank>GitHub</a></li><li><a href=https://twitter.com/raahiiy target=_blank>Twitter</a></li></ul></nav></header><main class=content role=main><article class=article><h1 class=article-title>Vim ALE と sql-formatter で SQL を整形する</h1><span class=article-date>September 20, 2022</span>
<span class=article-duration>1 min read</span><ul class="cp_tag01 article-categories">Categories:<li><a href=/categories/%E6%8A%80%E8%A1%93/>技術</a></li></ul><ul class="cp_tag01 article-tags">Tags:<li><a href=/tags/mysql/>mysql</a></li><li><a href=/tags/coc.nvim/>coc.nvim</a></li><li><a href=/tags/vim/>vim</a></li><li><a href=/tags/ale/>ale</a></li></ul><div class=article-content><p>最近データベーススペシャリストの勉強をしながら SQL を書いている中で、フォーマッタがほしいなと思ったので色々調査していた。Vim に <a href=https://github.com/dense-analysis/ale>ALE</a> というリンタプラグインがあるが、公式でサポートしている SQL 向けのフォーマットは下記の4つだ（2022/09 時点）。</p><ul><li><a href=https://dprint.dev/>dprint</a></li><li><a href=https://github.com/darold/pgFormatter>pgformatter</a></li><li><a href=https://github.com/jackc/sqlfmt>sqlfmt</a></li><li><a href=https://github.com/andialbrecht/sqlparse>sqlformat</a></li></ul><p><a href=https://github.com/dense-analysis/ale/blob/master/doc/ale-sql.txt>ale/ale-sql.txt · dense-analysis/ale</a></p><p>一通り使ってみた中では <code>pgformatter</code> が良かった。設定が豊富で、それらを <code>~/.pg_format</code> で管理することもできる。特に、コンマを行頭に持ってこれる整形オプションが好きで、こんなSQLが、</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#000;font-weight:700>SELECT</span><span style=color:#bbb> </span>po.id<span style=color:#bbb> </span>product_order_id,<span style=color:#bbb> </span>p.id<span style=color:#bbb> </span>product_id,<span style=color:#bbb> </span>p.name<span style=color:#bbb> </span>product_name,<span style=color:#bbb> </span>po.num_orders<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:#000;font-weight:700>FROM</span><span style=color:#bbb> </span>product_order<span style=color:#bbb> </span>po<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:#000;font-weight:700>JOIN</span><span style=color:#bbb> </span>product<span style=color:#bbb> </span>p<span style=color:#bbb> </span><span style=color:#000;font-weight:700>ON</span><span style=color:#bbb> </span>p.id<span style=color:#bbb> </span><span style=color:#000;font-weight:700>=</span><span style=color:#bbb> </span>po.product_id<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:#000;font-weight:700>WHERE</span><span style=color:#bbb> </span>p.is_set_product<span style=color:#bbb> </span><span style=color:#000;font-weight:700>=</span><span style=color:#bbb> </span><span style=color:#000;font-weight:700>TRUE</span><span style=color:#bbb>
</span></code></pre></div><p>こんな風にフォーマットされて良い。</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#000;font-weight:700>SELECT</span><span style=color:#bbb>
</span><span style=color:#bbb>    </span>po.id<span style=color:#bbb> </span>product_order_id<span style=color:#bbb>
</span><span style=color:#bbb>    </span>,<span style=color:#bbb> </span>p.id<span style=color:#bbb> </span>product_id<span style=color:#bbb>
</span><span style=color:#bbb>    </span>,<span style=color:#bbb> </span>p.name<span style=color:#bbb> </span>product_name<span style=color:#bbb>
</span><span style=color:#bbb>    </span>,<span style=color:#bbb> </span>po.num_orders<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:#000;font-weight:700>FROM</span><span style=color:#bbb>
</span><span style=color:#bbb>    </span>product_order<span style=color:#bbb> </span>po<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:#000;font-weight:700>JOIN</span><span style=color:#bbb> </span>product<span style=color:#bbb> </span>p<span style=color:#bbb> </span><span style=color:#000;font-weight:700>ON</span><span style=color:#bbb> </span>p.id<span style=color:#bbb> </span><span style=color:#000;font-weight:700>=</span><span style=color:#bbb> </span>po.product_id<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:#000;font-weight:700>WHERE</span><span style=color:#bbb>
</span><span style=color:#bbb>    </span>p.is_set_product<span style=color:#bbb> </span><span style=color:#000;font-weight:700>=</span><span style=color:#bbb> </span><span style=color:#000;font-weight:700>TRUE</span><span style=color:#bbb>
</span></code></pre></div><p>ところが、使っている中でコメント周りやサブクエリ周りの整形が微妙なことがわかったのと、<code>pgformatter</code> は PostgreSQL 向けなのに対し、私は MySQL 向けのSQLを書くことが多いので、代替を探していた。</p><p>すると、巷では明らかに <a href=https://github.com/sql-formatter-org/sql-formatter>sql-formatter-org/sql-formatter</a> が使われているようだった。例えば<a href=https://github.com/fannheyward/coc-sql>coc-sql</a> も採用している。サポートしているクエリ言語も手広いので、これを採用して ALE に組み込むことにした。</p><p>ALE では次のように任意のコマンドを組み込める。<code>-l</code> の言語指定はお好みで。</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>let g:ale_fixers = {
  ...
  \ &#39;sql&#39;: [
  \   { buffer -&gt; {
  \       &#39;command&#39;: &#39;sql-formatter -l mysql&#39;
  \   }},
  \ ]
\}
</code></pre></div><script id=asciicast-tGeh0GTOtzwjyVMlT9oI8KNSi src=https://asciinema.org/a/tGeh0GTOtzwjyVMlT9oI8KNSi.js async></script><p>これでめっちゃ快適にSQLを書けるようになった。</p><p>余談だが、仕事でもクエリを管理するためのレポがあって、DBオペの度にそこでレビュー受けてから実行するような運用なのだけれど、書き方が結構バラバラなので導入してみようかな。そういうチョットしたものでも、フォーマッタがある方が書く側もレビューする側も余計な時間を使わずに済んで良い。</p><p>あと、LSP があるのでなぜ未だに ALE つかっているの？と思う人もいるかも知れない。私は coc.nvim を使っているが、フォーマッタは自由に選んで差し替えられるようにしたいので、フォーマッタだけ ALE を使う運用を続けている。coc でフォーマットもやる場合は何もかもプラグインの実装次第なのだが、大体フォーマッタが無くて足したいとか、別のものを使いたいとか、そいつだけ無効にしたい、となり、でも設定が提供されていないとそこで詰むという感じで柔軟性に欠けるので止めた、という経緯です。</p></div></article><div id=disqus_thread></div><script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return}var b=document,a=b.createElement('script');a.async=!0,a.src='//raahii.disqus.com/embed.js',a.setAttribute('data-timestamp',+new Date),(b.head||b.body).appendChild(a)})()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a><h3>こちらの記事もどうぞ</h3><ul class="related-content article-content"><li><a href=/posts/setup-golint-coc-nvim/>coc.nvim で golint を使う</a></li><li><a href=/posts/docker-mysql-master-slave-replication/>MySQLのmaster slave構成をDockerで試す</a></li><li><a href=/posts/docker-proxysql-mysql-replication/>ProxySQLでMySQLの負荷分散をする</a></li></ul></main><footer class=footer><ul class=footer-links><li><a href=https://gohugo.io/ class=footer-links-kudos>Made with <img src=https://raahii.github.io/images/hugo-logo.png width=22 height=22 alt="hugo log"></a></li></ul></footer></div><script async src="https://www.googletagmanager.com/gtag/js?id=G-D4N0KPT2K2"></script><script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-D4N0KPT2K2',{anonymize_ip:!1})}</script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.10.1/dist/katex.min.css integrity=sha384-dbVIfZGuN1Yq7/1Ocstc1lUEm+AT+/rCkibIcC/OmWo5f0EA48Vf8CytHzGrSwbQ crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.10.1/dist/katex.min.js integrity=sha384-2BKqo+exmr9su6dir+qCw08N2ZKRucY4PrGQPPWU1A7FtlCGjmEGFqXCv5nyM5Ij crossorigin=anonymous></script><script defer src=https://cdn.jsdelivr.net/npm/katex@0.10.1/dist/contrib/auto-render.min.js integrity=sha384-kWPLUVMOks5AQFrykwIup5lo0m3iMkkHrD0uJ4H5cjeGihAutqP0yW0J6dpFiVkI crossorigin=anonymous onload=renderMathInElement(document.body)></script><script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}]})})</script></body></html>